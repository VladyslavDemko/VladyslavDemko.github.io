<!DOCTYPE html>
<html>
<head>
  <style>
    body { background:black; color:lime; font-family:monospace; text-align:center }
    .grid { display:grid; gap:5px; justify-content:center }
    .cell { width:40px; height:40px; border:1px solid lime }
    .on { background:red }
    .player{background:lime}
    .corpse {background:purple}
    .warning {background:orange}



    #controls {
  margin-top: 20px;
  display: grid;
  gap: 10px;
  justify-content: center;
  user-select: none;
  touch-action: manipulation;
}

#controls .row {
  display: flex;
  gap: 10px;
  justify-content: center;
}

#controls button {
  min-width: 60px;
  height: 60px;
  font-size: 24px;
  background: black;
  color: lime;
  border: 2px solid lime;
  border-radius: 12px;
}

#controls button:active {
  background: lime;
  color: black;
}
  </style>
</head>
<body>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<h3>Blind Bomber</h3>
<h3 id="PlayerCount">Server is offline, it will start in a minute</h3>
<h3>You and your enemies can only see each other's bombs. You are forced to drop a bomb every 10 seconds.</h3>
<h3 id="Stats">Stats: K0 D0</h3>
<div class="grid" id="grid"></div>
<h3 id = BombCooldown>Bomb Ready!</h3>
<h3 id = StaminaDisplay>Stamina: </h3>

<div class="grid" id="grid2"></div>
<div id="controls">
  <div class="row">
    <button id="up">W</button>
  </div>
  <div class="row">
    <button id="left">A</button>
    <button id="bomb">Space</button>
    <button id="right">D</button>
  </div>
  <div class="row">
    <button id="down">S</button>
  </div>
</div>

<script>
// @ts-check
//CHANGE THIS TO PRODUCTION SERVER BEFORE COMMIT
//const WS_URL = "ws://localhost:8000/ws";
const WS_URL = "wss://Blind-Bomber-Backend.onrender.com/ws";
const ws = new WebSocket(WS_URL);

//python -m http.server 8000
//uvicorn main:app --host 0.0.0.0 --port 8000 --reload
// ===== GRID =====
const grid = document.getElementById("grid");
const PlayerCount = document.getElementById("PlayerCount");
const Stats = document.getElementById("Stats");
const BombCooldown = document.getElementById("BombCooldown");
const StaminaDisplay = document.getElementById("StaminaDisplay");

let cells = [];
let gridSize = 5;
function buildGrid(size) {
  gridSize = size;
  cells = [];
  if (grid)
  grid.innerHTML = "";
  if (grid)
  grid.style.gridTemplateColumns = `repeat(${size}, 40px)`;

  for (let i = 0; i < size * size; i++) {
    const d = document.createElement("div");
    d.className = "cell";
    if (grid)
    grid.appendChild(d);
    cells.push(d);
  }

  // Clamp player position to new grid
  x = Math.min(x, size - 1);
  y = Math.min(y, size - 1);

  //clear();
  //plot(x, y);
}

function plot(x, y,type = "on") {
  const index = y * gridSize + x;
  if (cells[index]) {
    cells[index].classList.add(type);
  }
}
function ClearCell(x, y,type="all") {
  const index = y * gridSize + x;
  if (cells[index]) {
    if (type=="all")
    cells[index].classList.remove("on","corpse","warning","player");
  else
    cells[index].classList.remove(type);
  }
}
function clear(type="all") {
  if (type == "all")
  cells.forEach(c => c.classList.remove("on","corpse","warning","player"));
  else
{
cells.forEach(c => c.classList.remove(type));
}
}

function ResizeMap(playerCount)
{
if (playerCount ==4 ){buildGrid(6);return;}
else if (playerCount <= 3) {buildGrid(5);return;}
const factor = 5+Math.floor((playerCount-3)/2);
buildGrid(factor);
}
  
// ===== GAME STATE =====
let x,y;
let deaths =0;
let kills = 0;
let myId = null;
let canBomb= true;
let dead = false;
const MAXSTAMINA = 5;
let stamina = MAXSTAMINA;

setInterval(() => {
  SendBomb();
}, 10000);
setInterval(() => {
  if (stamina< MAXSTAMINA)stamina++;
  if (StaminaDisplay) StaminaDisplay.textContent = `Stamina: ${stamina}`;
}, 500);
ws.onopen = () => {
  ws.send("ping");
}; 

//python -m http.server 8000
//ResizeMap(1);
window.onload = () =>
{
  Respawn();
console.log("START");

};




// ===== MOVEMENT =====
function Move(direction)
{
  
  if (dead || stamina <= 0) return;
  if (stamina>0){stamina--;if (StaminaDisplay) StaminaDisplay.textContent = `Stamina: ${stamina}`;}
  ClearCell(x,y,"player")
  if (direction == "left" || direction =="a") x=Math.max(0,x-1);
  else if (direction == "right"|| direction =="d")x = Math.min(gridSize-1,x+1);
  else if (direction == "up"|| direction =="w")y=Math.max(0,y-1);
  else if (direction == "down"|| direction =="s")y=Math.min(gridSize-1,y+1);
   plot(x,y,"player");

}
// ===== RADIO SEND (SPACEBAR) =====
function SendBomb(){
  if (dead)return;
  if (canBomb)
 {
  const coords=[[x,y],[x+1,y],[x-1,y],[x,y+1],[x,y-1]];
  for (let [cx,cy] of coords){
    plot(cx,cy,"warning");
  }
  ws.send(`b;${myId};${x.toString()};${y.toString()}`);
  canBomb = false;
  setTimeout(() => {
    for (let [cx,cy] of coords){
    ClearCell(cx,cy,"warning");
  }
  }, 1500);
   setTimeout(() => {
  canBomb = true;
 }, 3000);
 CooldownBar();
 }

 
}
function CooldownBar() {
  let step = 0;
  if (BombCooldown)
  BombCooldown.textContent = "[     ]";
  const id = setInterval(() => {
    step++;
    if (BombCooldown)
    BombCooldown.textContent = "[" + "â–ˆ".repeat(step) + " ".repeat(5 - step) + "]";

    if (step >= 3) {
      clearInterval(id);
            if (BombCooldown)
    BombCooldown.textContent = "Bomb Ready!";
    }
  }, 1000);

}
// ===== RADIO RECEIVE =====
ws.onmessage = (event)=>{
  const msg = event.data;

    if (msg === "pong") {
      let data = msg.split(";")
      if (PlayerCount)
    PlayerCount.textContent = "Player Count: "+data[1];
    return;
    }
    let data = msg.split(";")
    console.log(msg);
    switch (data[0])
    {
      case "id": {
      myId = parseInt(data[1]);
      console.log("My ID:", myId);
      break; }
    
      case "cc":
        {
          if (PlayerCount)
          PlayerCount.textContent = "Player Count: "+data[1];
          ResizeMap(parseInt(data[1]));
          break;
        }
      case "b":
        {
          const killerId = parseInt(data[1]);
          const bx = parseInt(data[2]);
          const by = parseInt(data[3]);
          Explode(bx, by,killerId);
          break;
        }
      case "k"://k;KillerID;x;y
        {
          kills++;
          plot(parseInt(data[2]),parseInt(data[3]),"corpse");
          if (Stats)
          Stats.style.background = "yellow";
          setTimeout(() => {
            if (Stats)
            Stats.style.background = "black";
          }, 1000);
          
          UpdateStats(false);
          setTimeout(() => {
            ClearCell(parseInt(data[2]),parseInt(data[3]),"corpse");
          }, 8000);
          break;
        }
      }//switch
};

// ===== EXPLOSION =====
function Explode(bx,by,killerId){


  const coords=[[bx,by],[bx+1,by],[bx-1,by],[bx,by+1],[bx,by-1]];
  for (let [cx,cy] of coords){
    if (cx>=0&&cx<gridSize&&cy>=0&&cy<gridSize){
      plot(cx,cy);
      if (cx===x && cy===y)
      { 
        ws.send(`k;${killerId};${x};${y}`);
        Joever();
      }
    }
  }
  //Clear bomb visual
  setTimeout(() => {
    clear();
    if (!dead)
    plot(x,y,"player");
  
  }, 1000);
}

// ===== GAME OVER =====
function Joever(){
  deaths++;
  UpdateStats(true);
  if (Stats)
      Stats.style.background = "red";

  //clear();
  //Wait so everything processes before reloading
  dead=true;
  setTimeout(() => {
    Respawn();
    dead=false;
    if (Stats)
          Stats.style.background = "black";
  }, 3000);
}
//getRandomInt(3) will roll 0,1,2
function getRandomInt(max) {
  return Math.floor(Math.random() * max);
}
function Respawn()
{
  dead=false;
  x= getRandomInt(gridSize);
  y= getRandomInt(gridSize);
  clear();
  plot(x,y,"player");
  console.log(`x:${x}  y:${y}`);
  setTimeout(() => {
    plot(x,y,"player");
  }, 1000);
  
  
}
function UpdateStats(death)
{

  if (Stats)
  //Stat increase animation
  Stats.textContent = `Stats: K${(!death) ? kills-1+"+1" : kills} D${(death) ? deaths-1+"+1": deaths}`
  setTimeout(() => {
    if (Stats)
   Stats.textContent = `Stats: K${kills} D${deaths}` 
  }, 1500);
}
// ===== CONTROLS =====
document.addEventListener("keydown",e=>{
  Move(e.key);
  if(e.code==="Space") SendBomb();
});
function bindButton(id, action) {
  const btn = document.getElementById(id);
  if (!btn) return;

  // Touch
  btn.addEventListener("touchstart", e => {
    e.preventDefault();
    action();
  });

  // Mouse (for testing on desktop)
  btn.addEventListener("mousedown", e => {
    e.preventDefault();
    action();
  });
}

bindButton("up", Move("up"));
bindButton("down", Move("down"));
bindButton("left", Move("left"));
bindButton("right", Move("right"));
bindButton("bomb", SendBomb);

</script>
</body>
</html>
